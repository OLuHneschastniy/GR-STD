<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>üì± –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –†–∞–ø–æ—Ä—Ç–∏—á–∫–∏</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

<style>
:root {
    --primary: #2563eb;
    --primary-dark: #1e40af;
    --bg: #f3f4f6;
    --card-bg: #ffffff;
    --text: #1f2937;
    --border: #e5e7eb;
    --success: #10b981;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: var(--bg);
    color: var(--text);
    margin: 0;
    padding: 15px;
    padding-bottom: 80px; /* –ú—ñ—Å—Ü–µ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∑–Ω–∏–∑—É */
}

h1 {
    font-size: 1.5rem;
    text-align: center;
    margin-bottom: 20px;
    color: var(--primary-dark);
}

h2 {
    font-size: 1.1rem;
    margin: 0 0 15px 0;
    color: #4b5563;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
}

/* --- –ö–ê–†–¢–ö–ò --- */
.card {
    background: var(--card-bg);
    border-radius: 16px;
    padding: 20px;
    margin-bottom: 15px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

/* --- –í–ò–ë–Ü–† –°–¢–û–†–û–ù–ò --- */
.side-toggle {
    display: flex;
    background: #e0e7ff;
    border-radius: 12px;
    padding: 4px;
    margin-bottom: 15px;
}

.side-toggle label {
    flex: 1;
    text-align: center;
    padding: 10px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    transition: 0.2s;
    color: #4b5563;
}

.side-toggle input { display: none; }

.side-toggle input:checked + label {
    background: var(--primary);
    color: white;
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.3);
}

/* --- –í–í–û–î –î–ê–¢–ò --- */
.date-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
}
.full-width { grid-column: span 2; }

input, select {
    width: 100%;
    padding: 12px;
    border: 1px solid var(--border);
    border-radius: 8px;
    font-size: 16px; /* –©–æ–± iOS –Ω–µ –∑—É–º–∏–≤ –ø—Ä–∏ –∫–ª—ñ–∫—É */
    background: #fff;
    appearance: none;
}
input:focus, select:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
}

/* --- –†–û–ó–ö–õ–ê–î --- */
.pair-card {
    background: #f9fafb;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    margin-bottom: 10px;
}
.pair-header {
    font-weight: bold;
    font-size: 0.9rem;
    color: var(--primary);
    margin-bottom: 5px;
    display: block;
}
.pair-inputs {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* --- –°–¢–£–î–ï–ù–¢–ò --- */
.student-row {
    border-bottom: 1px solid var(--border);
    padding: 10px 0;
}
.student-row:last-child { border-bottom: none; }

.student-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
}

.student-name {
    font-size: 1rem;
    font-weight: 500;
}

/* –ì–∞—Ä–Ω–∏–π –ø–µ—Ä–µ–º–∏–∫–∞—á (Toggle) */
.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 28px;
}
.switch input { opacity: 0; width: 0; height: 0; }
.slider {
    position: absolute;
    cursor: pointer;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}
.slider:before {
    position: absolute;
    content: "";
    height: 20px;
    width: 20px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}
input:checked + .slider { background-color: var(--primary); }
input:checked + .slider:before { transform: translateX(22px); }

/* –î–µ—Ç–∞–ª—ñ —Å—Ç—É–¥–µ–Ω—Ç–∞ */
.student-details {
    display: none;
    margin-top: 10px;
    background: #f0f9ff;
    padding: 15px;
    border-radius: 10px;
    animation: slideDown 0.3s ease-out;
}
@keyframes slideDown {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

/* –ö–Ω–æ–ø–∫–∏ –¥–ª—è –ø–∞—Ä (0 1 2 3 4) */
.pair-bubbles {
    display: flex;
    justify-content: space-between;
    margin-top: 10px;
}
.pair-check-label {
    position: relative;
    width: 40px;
    height: 40px;
    background: white;
    border: 2px solid var(--border);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    color: #6b7280;
    cursor: pointer;
    transition: 0.2s;
}
.pair-check-input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
}
.pair-check-input:checked + .pair-check-label {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
    transform: scale(1.1);
}

/* --- –ì–û–õ–û–í–ù–ê –ö–ù–û–ü–ö–ê --- */
.fab-container {
    position: fixed;
    bottom: 20px;
    left: 20px;
    right: 20px;
    z-index: 100;
}
.btn-generate {
    width: 100%;
    background: var(--primary);
    color: white;
    border: none;
    padding: 16px;
    font-size: 1.1rem;
    font-weight: bold;
    border-radius: 12px;
    box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4);
    cursor: pointer;
    transition: 0.2s;
}
.btn-generate:active {
    transform: scale(0.98);
    background: var(--primary-dark);
}

/* Input file styling */
.file-upload {
    position: relative;
    display: inline-block;
    width: 100%;
}
.file-upload input[type="file"] {
    position: absolute;
    left: 0;
    top: 0;
    opacity: 0;
    width: 100%;
    height: 100%;
    cursor: pointer;
}
.file-btn {
    display: block;
    width: 100%;
    padding: 12px;
    background: white;
    border: 2px dashed var(--primary);
    color: var(--primary);
    text-align: center;
    border-radius: 8px;
    font-weight: 600;
}
</style>
</head>

<body>

<h1>üìÑ –†–∞–ø–æ—Ä—Ç–∏—á–∫–∞</h1>

<div class="card" style="padding: 10px;">
    <div class="side-toggle">
        <input type="radio" name="side" id="sideLeft" value="left" checked onchange="updateSideVal()">
        <label for="sideLeft">‚¨ÖÔ∏è –õ—ñ–≤–∞</label>
        
        <input type="radio" name="side" id="sideRight" value="right" onchange="updateSideVal()">
        <label for="sideRight">–ü—Ä–∞–≤–∞ ‚û°Ô∏è</label>
    </div>
    <input type="hidden" id="sideSelect" value="left">
</div>

<div class="card">
    <h2>1. –®–∞–±–ª–æ–Ω (.xlsx)</h2>
    <div class="file-upload">
        <div class="file-btn" id="fileNameDisplay">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –æ–±—Ä–∞—Ç–∏ —Ñ–∞–π–ª</div>
        <input type="file" id="uploadTemplate" accept=".xlsx" onchange="document.getElementById('fileNameDisplay').innerText = this.files[0].name">
    </div>
</div>

<div class="card">
    <h2>2. –î–∞—Ç–∞ —Ç–∞ –ì—Ä—É–ø–∞</h2>
    <div class="date-grid">
        <div>
            <label style="font-size:0.8rem; color:#666">–î–µ–Ω—å</label>
            <input type="number" id="dayInput">
        </div>
        <div>
             <label style="font-size:0.8rem; color:#666">–†—ñ–∫</label>
            <input type="number" id="yearInput">
        </div>
        <div class="full-width">
             <label style="font-size:0.8rem; color:#666">–ú—ñ—Å—è—Ü—å</label>
            <select id="monthInput">
                <option value="0">–°—ñ—á–Ω—è</option>
                <option value="1">–õ—é—Ç–æ–≥–æ</option>
                <option value="2">–ë–µ—Ä–µ–∑–Ω—è</option>
                <option value="3">–ö–≤—ñ—Ç–Ω—è</option>
                <option value="4">–¢—Ä–∞–≤–Ω—è</option>
                <option value="5">–ß–µ—Ä–≤–Ω—è</option>
                <option value="6">–õ–∏–ø–Ω—è</option>
                <option value="7">–°–µ—Ä–ø–Ω—è</option>
                <option value="8">–í–µ—Ä–µ—Å–Ω—è</option>
                <option value="9">–ñ–æ–≤—Ç–Ω—è</option>
                <option value="10">–õ–∏—Å—Ç–æ–ø–∞–¥–∞</option>
                <option value="11">–ì—Ä—É–¥–Ω—è</option>
            </select>
        </div>
        <div class="full-width">
             <label style="font-size:0.8rem; color:#666">–ì—Ä—É–ø–∞</label>
            <input type="text" id="groupInput" value="85">
        </div>
    </div>
</div>

<div class="card">
    <h2>3. –†–æ–∑–∫–ª–∞–¥</h2>
    <div id="schedule"></div>
</div>

<div class="card">
    <h2>4. –í—ñ–¥—Å—É—Ç–Ω—ñ</h2>
    <div id="students"></div>
</div>

<div class="fab-container">
    <button class="btn-generate" onclick="generateExcel()">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ Excel</button>
</div>

<script>
// –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è –≥–∞—Ä–Ω–æ–≥–æ –ø–µ—Ä–µ–º–∏–∫–∞—á–∞ –∑ –ª–æ–≥—ñ–∫–æ—é
function updateSideVal() {
    const isLeft = document.getElementById('sideLeft').checked;
    document.getElementById('sideSelect').value = isLeft ? 'left' : 'right';
}

// ===== –ê–í–¢–û–ú–ê–¢–ò–ß–ù–ê –î–ê–¢–ê =====
document.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    document.getElementById('dayInput').value = today.getDate();
    document.getElementById('monthInput').value = today.getMonth(); 
    document.getElementById('yearInput').value = today.getFullYear();
});

// ===== –î–ê–ù–Ü =====
const students = [
  "–ë—ñ–ª–µ–π –ú.–î.","–ë–æ–Ω–¥–∞—Ä–µ—Ü—å –ú.–†.","–ì–∞—Ä–∫—É—à–∞ –†.–°.","–î–µ–º—á–µ–Ω–∫–æ –í.–ê.","–Ñ–≤—Å—Ç—Ä–∞—Ç–µ–Ω–∫–æ –Ü.–í.",
  "–ó–∞–π—á–µ–Ω–∫–æ –Ø.–ü.","–ö–∏—Ä–ø–∞ –ì.–°.","–ö–ª–∏–º–µ–Ω–∫–æ –°.–û.","–ö–æ–ª–µ—Å–æ–≤ –ú.–í.","–ö–æ–ª—ñ—Å–Ω—ñ—á–µ–Ω–∫–æ –Ü.–ë.",
  "–ö—Ä–∏–≤–µ–Ω–∫–æ –ú.–û.","–õ–µ–¥–Ω—å–æ–≤ –Ñ.–û.","–ú–∞—Å–∞–ª–æ–≤–∞ –í.–ú.","–ú—É—Ä–∑—ñ–Ω –¢.–ë.","–ù–µ—Ç—É–¥–∏—Ö–∞—Ç–∞ –ë.–°.",
  "–ü–∏—Å—å–º–µ–Ω–Ω–∏–π –¢.–†.","–ü—ñ–Ω—å–∫–æ–≤—Å—å–∫–∏–π –ê.–†.","–°–∞–º–∞—Ä–µ—Ü—å –Ü.–î.","–°–∏–¥–æ—Ä–µ–Ω–∫–æ –û.–°.","–°–∫–ª—è—Ä–µ–Ω–∫–æ –†.–Ü.",
  "–¢–∫–∞—á–µ–Ω–∫–æ –í.–ú.","–¢—Ä–µ—Ç—è–∫ –ì.–ü.","–®–µ—Ä–µ–º–µ—Ç –î.–°.","–®–∫—É—Ä–µ–Ω–∫–æ –ü.–ö.","–®—É–ª—å–≥–∞ –û.–ì."
];

const reasons = [
  "–Ω–µ–º.—ñ–Ω—Ç.","—ñ–Ω–¥.","—Å—ñ–º. –æ–±—Å—Ç.","–∑–∞—Ö–≤–æ—Ä—ñ–≤","–±–µ–∑ –ø–æ–≤.–ø—Ä–∏—á.",
  "—Ö–≤–æ—Ä—ñ—î","—É –ª—ñ–∫–∞—Ä—è","–Ω–∞ –∫–æ–Ω–∫—É—Ä—Å—ñ","—Ç–µ—Ö–Ω. –ø—Ä–æ–±–ª.",
  "–ø–æ–≥. —Å–∞–º–æ–ø–æ—á.","–≤—ñ–¥—Å—Ç–æ—Ä–æ–Ω–µ–Ω–∏–π","–∑–∞–ø—ñ–∑–Ω."
];

const teachersDB = {
  "–ö–æ–º–ø'—é—Ç–µ—Ä–Ω—ñ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó": "–ì–æ–Ω—á–∞—Ä–æ–≤ –û.–ú.",
  "–Ü–Ω–æ–∑–µ–º–Ω–∞ –º–æ–≤–∞": "–¢–æ–∫–∞—Ä—î–≤–∞ –û.–í.",
  "–§—ñ–∑–∏–∫–∞ —ñ –∞—Å—Ç—Ä–æ–Ω–æ–º—ñ—è": "–ö–∞—Ä–ø–æ–≤–∞ –õ.–ú.",
  "–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (–ú2 '–ö—Ä–µ—Å–ª–µ–Ω–Ω—è')": "–í–∞—Å–∏–ª—å—á–µ–Ω–∫–æ –Ü.–Ü.",
  "–û—Å–Ω–æ–≤–∏ —Ç–µ–æ—Ä—ñ—ó –∫—ñ–ª": "–ß–æ—Ä–Ω–∏–π –û.–ê.",
  "–§—ñ–∑–∏—á–Ω–∞ –∫—É–ª—å—Ç—É—Ä–∞": "–§—ñ–ª—ñ–ø–ø–æ–≤ –î.–í.",
  "–Ü–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞": "–ñ–∏—Ç—á–µ–Ω–∫–æ –Ü.–ú.",
  "–¢–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó (–ú1 '–û—Å–Ω–æ–≤–∏')": "–ê–Ω–¥—Ä—î—î–≤ –í.–û.",
  "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –ª—ñ—Ç–µ—Ä–∞—Ç—É—Ä–∞": "–ü—Ä–æ—â–µ–Ω–∫–æ –Ü.–ú.",
  "–ë—ñ–æ–ª–æ–≥—ñ—è —ñ –µ–∫–æ–ª–æ–≥—ñ—è": "–®–∞–π—Ç–∞–Ω–æ–≤–∞ –û.–ú.",
  "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ –ê–ª–≥–µ–±—Ä–∞": "–ö–æ–≤–∞–ª—å –Ü.–ê.",
  "–Ü—Å—Ç–æ—Ä—ñ—è –£–∫—Ä–∞—ó–Ω–∏": "–î–æ–º–Ω—ñ–Ω–∞ –ì.–°.",
  "–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞ –º–æ–≤–∞": "–ü—Ä–æ—â–µ–Ω–∫–æ –Ü.–ú."
};

const monthNames = [
    "–°—ñ—á–Ω—è", "–õ—é—Ç–æ–≥–æ", "–ë–µ—Ä–µ–∑–Ω—è", "–ö–≤—ñ—Ç–Ω—è", "–¢—Ä–∞–≤–Ω—è", "–ß–µ—Ä–≤–Ω—è", 
    "–õ–∏–ø–Ω—è", "–°–µ—Ä–ø–Ω—è", "–í–µ—Ä–µ—Å–Ω—è", "–ñ–æ–≤—Ç–Ω—è", "–õ–∏—Å—Ç–æ–ø–∞–¥–∞", "–ì—Ä—É–¥–Ω—è"
];

// ===== –ì–ï–ù–ï–†–ê–¶–Ü–Ø –†–û–ó–ö–õ–ê–î–£ (Mobile Layout) =====
const schedule = document.getElementById("schedule");

for (let i = 0; i <= 4; i++) {
  schedule.innerHTML += `
    <div class="pair-card">
      <span class="pair-header">${i} –ø–∞—Ä–∞</span>
      <div class="pair-inputs">
        <select id="subj_${i}" onchange="autoTeacher(${i})">
            <option value="">‚Äî –û–±–µ—Ä—ñ—Ç—å –ø—Ä–µ–¥–º–µ—Ç ‚Äî</option>
            ${Object.keys(teachersDB).map(s => `<option value="${s}">${s}</option>`).join("")}
            <option value="custom">–í–ø–∏—Å–∞—Ç–∏ –≤—Ä—É—á–Ω—É...</option>
        </select>
        <input id="teach_${i}" placeholder="–ü—Ä—ñ–∑–≤–∏—â–µ –≤–∏–∫–ª–∞–¥–∞—á–∞">
      </div>
    </div>`;
}

function autoTeacher(i) {
  const subjEl = document.getElementById(`subj_${i}`);
  const teacherEl = document.getElementById(`teach_${i}`);
  const subjValue = subjEl.value;

  if (teachersDB[subjValue]) {
    teacherEl.value = teachersDB[subjValue];
  } else if (subjValue !== "custom") {
    teacherEl.value = "";
  }

  const isSelected = (subjValue !== "");

  students.forEach((_, studentIndex) => {
    // –®—É–∫–∞—î–º–æ –Ω–∞—à—ñ –Ω–æ–≤—ñ "–ø—É–∑–∏—Ä—á–∞—Å—Ç—ñ" —á–µ–∫–±–æ–∫—Å–∏
    const checkboxes = document.querySelectorAll(`.p${studentIndex}`);
    checkboxes.forEach(cb => {
        if (cb.value == i) {
            cb.checked = isSelected;
        }
    });
  });
}

// ===== –ì–ï–ù–ï–†–ê–¶–Ü–Ø –°–¢–£–î–ï–ù–¢–Ü–í (Mobile Toggle) =====
const studentsDiv = document.getElementById("students");

students.forEach((s, i) => {
  studentsDiv.innerHTML += `
    <div class="student-row">
      <div class="student-header">
        <span class="student-name">${s}</span>
        <label class="switch">
            <input type="checkbox" id="chk_${i}" onchange="toggle(${i})">
            <span class="slider"></span>
        </label>
      </div>
      
      <div class="student-details" id="det_${i}">
        <label style="font-size:0.8rem; color:#666">–ü—Ä–∏—á–∏–Ω–∞:</label>
        <select id="reason_${i}" style="margin-top:5px; margin-bottom:15px;">
          ${reasons.map(r => `<option>${r}</option>`).join("")}
        </select>

        <label style="font-size:0.8rem; color:#666">–ü—Ä–æ–ø—É—â–µ–Ω—ñ –ø–∞—Ä–∏:</label>
        <div class="pair-bubbles">
          ${[0,1,2,3,4].map(pairNum => `
            <div>
              <input type="checkbox" class="pair-check-input p${i}" id="p_${i}_${pairNum}" value="${pairNum}">
              <label for="p_${i}_${pairNum}" class="pair-check-label">${pairNum}</label>
            </div>
          `).join('')}
        </div>
      </div>
    </div>`;
});

function toggle(i) {
  const details = document.getElementById(`det_${i}`);
  const isChecked = document.getElementById(`chk_${i}`).checked;
  
  if (isChecked) {
      details.style.display = "block";
  } else {
      details.style.display = "none";
  }
}

// ===== EXCEL –õ–û–ì–Ü–ö–ê (–ë–ï–ó –ó–ú–Ü–ù) =====

function styleCell(cell, bold, size=11, italic=false) {
  cell.font = { name: "Times New Roman", size: size, bold: bold, italic: italic };
  cell.alignment = { horizontal: "center", vertical: "middle" };
}

async function generateExcel() {
  const file = document.getElementById("uploadTemplate").files[0];
  if (!file) { alert("‚ö†Ô∏è –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ñ–∞–π–ª —à–∞–±–ª–æ–Ω—É!"); return; }

  const side = document.getElementById("sideSelect").value;
  
  // –ö–æ–ª–æ–Ω–∫–∏ (–∑—ñ –∑–º—ñ—â–µ–Ω–Ω—è–º –Ω–∞ 1 –∫–ª—ñ—Ç–∏–Ω–∫—É –≤–ø–µ—Ä–µ–¥ –¥–ª—è –ø—Ä–∞–≤–æ—ó —á–∞—Å—Ç–∏–Ω–∏)
  const cols = {
      header:   side === 'left' ? "A2" : "K2",
      subject:  side === 'left' ? "B"  : "L",
      teacher:  side === 'left' ? "C"  : "M",
      grades:   side === 'left' ? ["C","D","E","F","G"] : ["M","N","O","P","Q"], 
      total:    side === 'left' ? "H"  : "R"
  };

  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(await file.arrayBuffer());
  const ws = wb.getWorksheet(1);

  const day = document.getElementById('dayInput').value;
  const monthIdx = document.getElementById('monthInput').value;
  const yearFull = document.getElementById('yearInput').value.toString();
  const groupNum = document.getElementById('groupInput').value;
  const monthStr = monthNames[monthIdx];
  const yearPrefix = yearFull.substring(0, 2); 
  const yearSuffix = yearFull.substring(2, 4);

  const fontBase = { name: 'Times New Roman', size: 10 };
  const fontUnder = { name: 'Times New Roman', size: 10, underline: true };
  const fontYearPrefix = { name: 'Times New Roman', size: 10, bold: true, italic: true }; 
  const fontYearSuffix = { name: 'Times New Roman', size: 10, bold: true, italic: true, underline: true };

  const headerCell = ws.getCell(cols.header);
  headerCell.value = {
    richText: [
      { text: '"', font: fontBase },
      { text: '  ' + day + '  ', font: fontUnder }, 
      { text: '"   ', font: fontBase },
      { text: '   ' + monthStr, font: fontUnder }, 
      { text: ' ', font: fontBase },
      { text: yearPrefix, font: fontYearPrefix },
      { text: yearSuffix, font: fontYearSuffix },
      { text: ' —Ä.  –ì—Ä. ‚Ññ', font: fontBase }, 
      { text: '  ' + groupNum + '  ', font: fontUnder },
      { text: '.', font: fontBase }
    ]
  };
  headerCell.alignment = { horizontal: "center", vertical: "middle" };

  const rowMap = {0:4, 1:5, 2:6, 3:7, 4:8}; 
  
  for (let i = 0; i <= 4; i++) {
    const subjVal = document.getElementById(`subj_${i}`).value;
    const teachVal = document.getElementById(`teach_${i}`).value;
    
    if (subjVal || teachVal) {
        ws.getCell(`${cols.subject}${rowMap[i]}`).value = subjVal;
        ws.getCell(`${cols.teacher}${rowMap[i]}`).value = teachVal;
        styleCell(ws.getCell(`${cols.subject}${rowMap[i]}`), false);
        styleCell(ws.getCell(`${cols.teacher}${rowMap[i]}`), false);
    }
  }

  let row = 11; 
  students.forEach((s, i) => {
    if(document.getElementById(`chk_${i}`).checked){
      const reason = document.getElementById(`reason_${i}`).value;
      
      const nameCell = ws.getCell(`${cols.subject}${row}`);
      nameCell.value = `${s} (${reason})`;
      nameCell.font = { name: "Times New Roman", size: 11, italic: false };
      nameCell.alignment = { horizontal: "center", vertical: "middle" };

      let hours = 0;
      document.querySelectorAll(`.p${i}:checked`).forEach(p => {
        const pairIndex = p.value;
        const colLetter = cols.grades[pairIndex];
        if (colLetter) {
            ws.getCell(`${colLetter}${row}`).value = "2";
            styleCell(ws.getCell(`${colLetter}${row}`), true, 11, false);
            hours += 2;
        }
      });

      ws.getCell(`${cols.total}${row}`).value = hours;
      styleCell(ws.getCell(`${cols.total}${row}`), true, 11, false);
      row++;
    }
  });

  const buf = await wb.xlsx.writeBuffer();
  const sideSuffix = side === 'left' ? '_Left' : '_Right';
  saveAs(new Blob([buf]), `raport_${day}_${monthStr}${sideSuffix}.xlsx`);
}
</script>

</body>
</html>
